/*
Copyright (c) 2008-2009, OpenGeo
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

    * Redistributions of source code must retain the above copyright notice,
      this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
    * Neither the name of the Open Planning Project nor the names
      of its contributors may be used to endorse or promote products derived
      from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
*/

var dataLayers=[];var LayerData=function(iid,isearchFields,icategory,icount)
{this.id=iid;this.searchFields=isearchFields;this.category=icategory;this.count=icount;};var GeoExplorer=Ext.extend(gxp.Viewer,{localGeoServerBaseUrl:"",fromLayer:false,mapPanel:null,legendPanel:null,toolbar:null,capGrid:null,modified:0,popupCache:null,propDlgCache:null,stylesDlgCache:null,busyMask:null,urlPortRegEx:/^(http[s]?:\/\/[^:]*)(:80|:443)?\//,treeRoot:null,searchFields:new Array(),addLayersButtonText:"UT:Add Layers",areaActionText:"UT:Area",backgroundContainerText:"UT:Background",capGridAddLayersText:"UT:Add Layers",capGridDoneText:"UT:Done",capGridText:"UT:Available Layers",connErrorTitleText:"UT:Connection Error",connErrorText:"UT:The server returned an error",connErrorDetailsText:"UT:Details...",heightLabel:'UT: Height',infoButtonText:"UT:Get Feature Info",largeSizeLabel:'UT:Large',layerAdditionLabel:"UT:+",layerLocalLabel:'UT:Upload your own data',layerContainerText:"UT:Map Layers",layerPropertiesText:'UT: Layer Properties',layerPropertiesTipText:'UT: Change layer format and style',layerStylesText:'UT:Edit Styles',layerStylesTipText:'UT:Edit layer styles',layerSelectionLabel:"UT:View available data from:",layersContainerText:"UT:Data",layersPanelText:"UT:Layers",legendPanelText:"UT:Legend",lengthActionText:"UT:Length",loadingMapMessage:"UT:Loading Map...",mapSizeLabel:'UT: Map Size',measureSplitText:"UT:Measure",metadataFormCancelText:"UT:Cancel",metadataFormSaveAsCopyText:"UT:Save as Copy",metadataFormSaveText:"UT:Save",metaDataHeader:'UT:About this Map View',metaDataMapAbstract:'UT:Abstract (brief description)',metaDataMapKeywords:'UT: Keywords (for Picasa and YouTube overlays)',metaDataMapIntroText:'UT:Introduction (tell visitors more about your map view)',metaDataMapTitle:'UT:Title',metaDataMapUrl:'UT:UserUrl',miniSizeLabel:'UT: Mini',renameCategoryActionText:'UT: Rename Category',renameCategoryActionTipText:'UT: Rename this category',removeCategoryActionText:'UT: Remove Category',removeCategoryActionTipText:'UT: Remove this category and layers',navActionTipText:"UT:Pan Map",navNextAction:"UT:Zoom to Next Extent",navPreviousActionText:"UT:Zoom to Previous Extent",premiumSizeLabel:'UT: Premium',printTipText:"UT:Print Map",printWindowTitleText:"UT:Print Preview",propertiesText:"UT:Properties",publishActionText:'UT:Publish Map',removeLayerActionText:"UT:Remove Layer",removeLayerActionTipText:"UT:Remove Layer",saveFailMessage:"UT: Sorry, your map could not be saved.",saveFailTitle:"UT: Error While Saving",saveMapText:"UT: Save Map",saveMapAsText:"UT: Save Map As",saveNotAuthorizedMessage:"UT: You Must be logged in to save this map.",smallSizeLabel:'UT: Small',sourceLoadFailureMessage:'UT: Error contacting server.\n Please check the url and try again.',switchTo3DActionText:"UT:Switch to Google Earth 3D Viewer",unknownMapMessage:'UT: The map that you are trying to load does not exist.  Creating a new map instead.',unknownMapTitle:'UT: Unknown Map',unsupportedLayersTitleText:'UT:Unsupported Layers',unsupportedLayersText:'UT:The following layers cannot be printed:',widthLabel:'UT: Width',zoomInActionText:"UT:Zoom In",zoomOutActionText:"UT:Zoom Out",zoomSelectorText:'UT:Zoom level',zoomSliderTipText:"UT: Zoom Level",zoomToLayerExtentText:"UT:Zoom to Layer Extent",zoomVisibleButtonText:"UT:Zoom to Original Map Extent",constructor:function(config){this.config=config;this.popupCache={};this.propDlgCache={};this.stylesDlgCache={};this.addEvents("saved","beforeunload");Ext.util.Observable.observeClass(Ext.data.Connection);Ext.data.Connection.on({"beforerequest":function(conn,options){var url=options.url.replace(this.urlPortRegEx,"$1/");var localUrl=this.localGeoServerBaseUrl.replace(this.urlPortRegEx,"$1/");if(url.indexOf(localUrl+"rest/")===0){options.url=url.replace(new RegExp("^"+
localUrl),"/geoserver/");return;};if(this.proxy&&options.url.indexOf(this.proxy)!==0&&options.url.indexOf(window.location.protocol)===0){var parts=options.url.replace(/&$/,"").split("?");var params=Ext.apply(parts[1]&&Ext.urlDecode(parts[1])||{},options.params);var url=Ext.urlAppend(parts[0],Ext.urlEncode(params));delete options.params;options.url=this.proxy+encodeURIComponent(url);}},"requestexception":function(conn,response,options){if(options.failure){}else{this.busyMask&&this.busyMask.hide();var url=options.url;if(response.status==401&&url.indexOf("http"!=0)&&url.indexOf(this.proxy)===-1){var submit=function(){form.getForm().submit({waitMsg:"Logging in...",success:function(form,action){win.close();document.cookie=action.response.getResponseHeader("Set-Cookie");Ext.Ajax.request(options);},failure:function(form,action){var username=form.items.get(0);var password=form.items.get(1);username.markInvalid();password.markInvalid();username.focus(true);},scope:this});}.bind(this);var win=new Ext.Window({title:"Geolayertree"+" Login",modal:true,width:230,autoHeight:true,layout:"fit",items:[{xtype:"form",autoHeight:true,labelWidth:55,border:false,bodyStyle:"padding: 10px;",url:"/accounts/ajax_login",waitMsgTarget:true,errorReader:{read:function(response){return{success:response.status==200,records:[]}}},defaults:{anchor:"100%"},items:[{xtype:"textfield",name:"username",fieldLabel:"Username"},{xtype:"textfield",name:"password",fieldLabel:"Password",inputType:"password"},{xtype:"hidden",name:"csrfmiddlewaretoken",value:this.csrfToken},{xtype:"button",text:"Login",inputType:"submit",handler:submit}]}],keys:{"key":Ext.EventObject.ENTER,"fn":submit}});win.show();var form=win.items.get(0);form.items.get(0).focus(false,100);}else{this.displayXHRTrouble(response);}}},scope:this});window.onbeforeunload=(function(){if(this.fireEvent("beforeunload")===false){return"If you leave this page, unsaved changes will be lost.";}}).bind(this);Ext.util.Observable.observeClass(gxp.form.ColorField);gxp.form.ColorField.on({render:function(field){var manager=new Styler.ColorManager();manager.register(field);}});Ext.form.ComboBox.prototype.getListParent=function(){return this.el.up(".x-window")||document.body;}
Ext.Window.prototype.shadow=false;OpenLayers.Renderer.defaultSymbolizer={fillColor:"#808080",fillOpacity:1,strokeColor:"#000000",strokeOpacity:1,strokeWidth:1,strokeDashstyle:"solid",pointRadius:3,graphicName:"square",fontColor:"#000000",fontSize:10,haloColor:"#FFFFFF",haloOpacity:1,haloRadius:1};OpenLayers.Tile.Image.prototype.maxGetUrlLength=2048;if(!config.map){config.map={};}
config.map.numZoomLevels=config.map.numZoomLevels||22;GeoExplorer.superclass.constructor.apply(this,arguments);this.mapID=this.initialConfig.id;},addCategoryFolder:function(category,isExpanded){mapRoot=this.treeRoot.findChild("id","maplayerroot");if(category==""||category==undefined||category==null)
category="General";if(mapRoot.findChild("text",category)==null)
{mapRoot.appendChild(new GeoExt.tree.LayerContainer({text:category,group:category,iconCls:"gx-folder",cls:"folder",expanded:isExpanded=="true",loader:new GeoExt.tree.LayerLoader({store:this.mapPanel.layers,filter:function(record){return record.get("group")==category&&record.getLayer().displayInLayerSwitcher==true;},createNode:function(attr){var layer=attr.layer;var store=attr.layerStore;if(layer&&store){var record=store.getAt(store.findBy(function(r){return r.getLayer()===layer;}));if(record&&!record.get("queryable")){attr.iconCls="gx-tree-rasterlayer-icon";}}
return GeoExt.tree.LayerLoader.prototype.createNode.apply(this,[attr]);}}),singleClickExpand:true,allowDrag:true,listeners:{append:function(tree,node){node.expand();}}}));}else if(isExpanded=="true"){(mapRoot.findChild("text",category)).expand();}},onMapClick:function(e){var pixel=new OpenLayers.Pixel(e.xy.x,e.xy.y);var lonlat=this.mapPanel.map.getLonLatFromPixel(pixel);GeoExplorer.Results.target=this;var count=0,successCount=0,featureCount=0;var features=[];var featureMeta=[];var queryableLayers=this.mapPanel.layers.queryBy(function(x){return x.get("queryable");});queryableLayers.each(function(x){if(x.getLayer().getVisibility())
count++;});var map=this.mapPanel.map;queryableLayers.each(function(x){var dl=x.getLayer();if(dl.getVisibility()){wfs_url=dl.url;if(wfs_url.indexOf("wms")!=-1)
{wfs_url=wfs_url.substring(0,wfs_url.indexOf("wms"));}
var clickTolerance=10;pixel=e.xy;var llPx=pixel.add(-clickTolerance/2,clickTolerance/2);var urPx=pixel.add(clickTolerance/2,-clickTolerance/2);var ll=map.getLonLatFromPixel(llPx);var ur=map.getLonLatFromPixel(urPx);var bounds=new OpenLayers.Bounds(ll.lon,ll.lat,ur.lon,ur.lat);wfs_url+="wfs?request=GetFeature&version=1.1.0&srsName=EPSG:900913&outputFormat=json&typeName="+dl.params.LAYERS+"&BBOX="+bounds.toBBOX()+",EPSG:900913";Ext.Ajax.request({'url':wfs_url,'success':function(resp,opts){successCount++;if(resp.responseText!=''&&resp.responseText.substr(0,1)!="{"){msg=resp.responseText;Ext.Msg.alert('Results for '+x.get("title"),msg);return;}
if(resp.responseText!=''){var featureInfo=new OpenLayers.Format.GeoJSON().read(resp.responseText);if(featureInfo){if(featureInfo.constructor!=Array){featureInfo=[featureInfo];}
featureInfo.title=x.get("title");if(dataLayers[dl.params.LAYERS].searchFields.length>0){featureInfo.queryfields=dataLayers[dl.params.LAYERS].searchFields;featureInfo.nameField=featureInfo.queryfields[0].attribute;}else{featureInfo.queryFields=[];featureInfo.nameField=[];}
for(var f=0;f<featureInfo.length;f++)
{feature=featureInfo[f];feature.wm_layer_id=featureCount;feature.wm_layer_title=featureInfo.title;feature.wm_layer_name=feature.attributes[featureInfo.nameField];feature.wm_layer_type=dl.params.LAYERS;featureCount++;features=features.concat(feature);}}
featureMeta[dl.params.LAYERS]=featureInfo.queryfields;}
if(successCount==count){if(features.length==0){Ext.Msg.alert('Map Results','No features found at this location.');}else{GeoExplorer.Results.displayXYResults(features,featureMeta,e.xy);}}},'failure':function(resp,opts){var msg='The feature request failed.';msg+='<br />details: '+resp.responseText;Ext.Msg.alert('Request Failed',msg);},'headers':{},'params':{}});}});if(count==0){Ext.Msg.alert('Searchable Layers','There are no searchable layers active.');}},displayXHRTrouble:function(response){response.status&&Ext.Msg.show({title:this.connErrorTitleText,msg:this.connErrorText+": "+response.status+" "+response.statusText,icon:Ext.MessageBox.ERROR,buttons:{ok:this.connErrorDetailsText,cancel:true},fn:function(result){if(result=="ok"){var details=new Ext.Window({title:response.status+" "+response.statusText,width:400,height:300,items:{xtype:"container",cls:"error-details",html:response.responseText},autoScroll:true,buttons:[{text:"OK",handler:function(){details.close();}}]});details.show();}}});},initMapPanel:function(){this.mapItems=[{xtype:"gx_zoomslider",vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:"<div>"+this.zoomSliderTipText+": {zoom}<div>"})}];OpenLayers.IMAGE_RELOAD_ATTEMPTS=10;OpenLayers.Util.onImageLoadErrorColor="transparent";GeoExplorer.superclass.initMapPanel.apply(this,arguments);var searchFields=this.searchFields;var layerCount=0;this.mapPanel.map.events.register("addLayers",this,function(e){var layer=e.layer;var layerfields='';if(layer instanceof OpenLayers.Layer.WMS){!layer.singleTile&&layer.maxExtent&&layer.mergeNewParams({tiled:true,tilesOrigin:[layer.maxExtent.left,layer.maxExtent.bottom]});layer.events.on({"loadstart":function(){layerCount++;if(!this.busyMask){this.busyMask=new Ext.LoadMask(this.mapPanel.map.div,{msg:this.loadingMapMessage});this.busyMask.show();}
layer.events.unregister("loadstart",this,arguments.callee);},"loadend":function(){layerCount--;if(layerCount===0){this.busyMask.hide();}
layer.events.unregister("loadend",this,arguments.callee);},scope:this})}});},initPortal:function(){this.on("beforeunload",function(){if(this.modified&&this.config["edit_map"]){this.showMetadataForm();return false;}},this);var mapOverlay=this.createMapOverlay();this.mapPanel.add(mapOverlay);var logoOverlay=this.createLogoOverlay();this.mapPanel.add(logoOverlay);var addLayerButton=new Ext.Button({tooltip:this.addLayersButtonText,disabled:false,iconCls:"icon-addlayers",handler:this.showCapabilitiesGrid,scope:this});this.on("ready",function(){this.mapPanel.map.events.register('click',this,this.onMapClick);this.mapPanel.layers.on({"update":function(){this.modified|=1;},"add":function(){this.modified|=1;},"remove":function(store,rec){this.modified|=1;delete this.stylesDlgCache[rec.getLayer().id];},scope:this});if(this.config.first_visit)
this.showInfoWindow();});var getRecordFromNode=function(node){if(node&&node.layer){var layer=node.layer;var store=node.layerStore;record=store.getAt(store.findBy(function(r){return r.getLayer()===layer;}));}
return record;};var getSelectedLayerRecord=function(){var node=layerTree.getSelectionModel().getSelectedNode();return getRecordFromNode(node);};var removeLayerAction=new Ext.Action({text:this.removeLayerActionText,iconCls:"icon-removelayers",disabled:true,tooltip:this.removeLayerActionTipText,handler:function(){var record=getSelectedLayerRecord();if(record){this.mapPanel.layers.remove(record);removeLayerAction.disable();}},scope:this});this.treeRoot=new Ext.tree.TreeNode({text:"Layers",expanded:true,isTarget:false,allowDrop:false});this.treeRoot.appendChild(new GeoExt.tree.LayerContainer({text:this.layerContainerText,id:"maplayerroot",iconCls:"gx-folder",expanded:true,loader:new GeoExt.tree.LayerLoader({store:this.mapPanel.layers,filter:function(record){return record.get("group")=="none"&&record.getLayer().displayInLayerSwitcher==true;},createNode:function(attr){var layer=attr.layer;var store=attr.layerStore;if(layer&&store){var record=store.getAt(store.findBy(function(r){return r.getLayer()===layer;}));if(record&&!record.get("queryable")){attr.iconCls="gx-tree-rasterlayer-icon";}}
return GeoExt.tree.LayerLoader.prototype.createNode.apply(this,[attr]);}}),singleClickExpand:true,allowDrop:true,allowDrag:true,listeners:{append:function(tree,node){node.expand();}}}));this.treeRoot.appendChild(new GeoExt.tree.LayerContainer({text:this.backgroundContainerText,iconCls:"gx-folder",expanded:true,group:"background",loader:new GeoExt.tree.LayerLoader({baseAttrs:{checkedGroup:"background"},store:this.mapPanel.layers,filter:function(record){return record.get("group")==="background"&&record.getLayer().displayInLayerSwitcher==true;},createNode:function(attr){var layer=attr.layer;var store=attr.layerStore;if(layer&&store){var record=store.getAt(store.findBy(function(r){return r.getLayer()===layer;}));if(record){if(!record.get("queryable")){attr.iconCls="gx-tree-rasterlayer-icon";}
if(record.get("fixed")){attr.allowDrag=false;}}}
return GeoExt.tree.LayerLoader.prototype.createNode.apply(this,arguments);}}),singleClickExpand:true,allowDrag:false,listeners:{append:function(tree,node){node.expand();}}}));createPropertiesDialog=function(){var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){var layer=node.layer;var store=node.layerStore;var record=store.getAt(store.findBy(function(record){return record.getLayer()===layer;}));var backupParams=Ext.apply({},record.getLayer().params);var prop=this.propDlgCache[layer.id];if(!prop){prop=this.propDlgCache[layer.id]=new Ext.Window({title:"Properties: "+record.getLayer().name,width:280,autoHeight:true,closeAction:"hide",items:[{xtype:"gx_wmslayerpanel",autoHeight:true,layerRecord:record,defaults:{autoHeight:true,hideMode:"offsets"},listeners:{"change":function(){this.modified|=1;},scope:this}}]});prop.items.get(0).items.get(1).cascade(function(i){i instanceof Ext.form.Field&&i.setDisabled(true);});prop.items.get(0).items.get(0).add({html:"<a href='/data/"+layer.params.LAYERS+"'>Metadata</a>",xtype:"panel"});var stylesPanel=this.createStylesPanel({layerRecord:record});stylesPanel.items.get(0).on({"styleselected":function(){this.modified|=1;},"modified":function(){this.modified|=2;},scope:this});stylesPanel.setTitle("Styles");prop.items.get(0).add(stylesPanel)}
prop.show();}};var showPropertiesAction=new Ext.Action({text:this.layerPropertiesText,iconCls:"icon-layerproperties",disabled:true,tooltip:this.layerPropertiesTipText,handler:createPropertiesDialog.createSequence(function(){var node=layerTree.getSelectionModel().getSelectedNode();this.propDlgCache[node.layer.id].items.get(0).setActiveTab(1);},this),scope:this,listeners:{"enable":function(){showStylesAction.enable()},"disable":function(){showStylesAction.disable()}}});var showStylesAction=new Ext.Action({text:this.layerStylesText,iconCls:"icon-layerstyles",disabled:true,tooltip:this.layerStylesTipText,handler:createPropertiesDialog.createSequence(function(){var node=layerTree.getSelectionModel().getSelectedNode();this.propDlgCache[node.layer.id].items.get(0).setActiveTab(2);},this),scope:this});var updateLayerActions=function(sel,node){if(node&&node.layer){removeLayerAction.show();zoomLayerAction.show();showPropertiesAction.show();showStylesAction.show();var count=this.mapPanel.layers.queryBy(function(r){return!(r.getLayer()instanceof OpenLayers.Layer.Vector);}).getCount();if(count>1){removeLayerAction.enable();zoomLayerAction.enable();}else{zoomLayerAction.disable();removeLayerAction.disable();}
var record=getRecordFromNode(node);if(record.get("properties")){showPropertiesAction.enable();}else{showPropertiesAction.disable();}
removeCategoryAction.hide();renameAction.hide();}else{removeLayerAction.hide();showPropertiesAction.hide();showStylesAction.hide();zoomLayerAction.hide();if(node)
{removeCategoryAction.show();renameAction.show();}}};var zoomLayerAction=new Ext.Action({text:this.zoomToLayerExtentText,disabled:true,iconCls:"icon-zoom-to",handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){var map=this.mapPanel.map;var extent=node.layer.restrictedExtent||map.maxExtent;map.zoomToExtent(extent,true);}},scope:this})
var renameNode=function(node){Ext.MessageBox.prompt('Rename Category','New name for \"'+node.text+'\"',function(btn,text){if(btn=='ok'){var a=node;node.setText(text);node.attributes.group=text;node.eachChild(function(n){record=getRecordFromNode(n);if(record){record.set("group",text);}});node.ownerTree.fireEvent('beforechildrenrendered',node.parentNode);}});};var renameAction=new Ext.Action({text:this.renameCategoryActionText,iconCls:"icon-layerproperties",disabled:false,tooltip:this.renameCategoryActionTipText,handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();renameNode(node);},scope:this});var removeCategoryAction=new Ext.Action({text:this.removeCategoryActionText,iconCls:"icon-removelayers",disabled:false,tooltip:this.removeCategoryActionTipText,handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();while(node.childNodes.length>0){cnode=node.childNodes[0];record=getRecordFromNode(cnode);if(record){this.mapPanel.layers.remove(record);}};parentNode=node.parentNode;parentNode.removeChild(node);},scope:this});var layerTree=new Ext.tree.TreePanel({root:this.treeRoot,rootVisible:false,border:false,enableDD:true,selModel:new Ext.tree.DefaultSelectionModel({listeners:{beforeselect:updateLayerActions,scope:this}}),listeners:{contextmenu:function(node,e){if(node){node.select();var c=node.getOwnerTree().contextMenu;c.contextNode=node;c.showAt(e.getXY());}},beforemovenode:function(tree,node,oldParent,newParent,index){if(node.layer&&oldParent!==newParent){var store=newParent.loader.store;var index=store.findBy(function(r){return r.getLayer()===node.layer;});var record=store.getAt(index);record.set("group",newParent.attributes.group);}},beforenodedrop:function(dropEvent){var source_folder_id=undefined;var dest_folder=undefined;if(dropEvent.data.node.attributes.iconCls=='gx-folder'){alert(dropEvent.target.attributes.iconCls+":"+dropEvent.point+":"+dropEvent.target.parentNode.text);if(dropEvent.target.attributes.iconCls!="gx-folder")
dropEvent.target=dropEvent.target.parentNode;if((dropEvent.target.attributes.iconCls=='gx-folder'&&dropEvent.point=="above")||(dropEvent.target.text!='Background'&&dropEvent.target.attributes.iconCls=='gx-folder'&&dropEvent.point=="below")){return true;}else{return false;}}else{alert(dropEvent.target.parentNode.text);if(dropEvent.target.parentNode.text=='Background'||dropEvent.target.parentNode.text=='Layers')
return false;else
return true;}},scope:this},contextMenu:new Ext.menu.Menu({items:[zoomLayerAction,removeLayerAction,showPropertiesAction,showStylesAction,renameAction,removeCategoryAction]})});var layersContainer=new Ext.Panel({autoScroll:true,border:false,title:this.layersContainerText,items:[layerTree],tbar:[addLayerButton,Ext.apply(new Ext.Button(removeLayerAction),{text:""}),Ext.apply(new Ext.Button(showPropertiesAction),{text:""}),Ext.apply(new Ext.Button(showStylesAction),{text:""})]});this.legendPanel=new GeoExt.LegendPanel({title:this.legendPanelText,border:false,hideMode:"offsets",split:true,autoScroll:true,ascending:false,map:this.mapPanel.map,filter:function(record){return record.data.group==undefined||record.data.group!="Overlays";},defaults:{cls:'legend-item'}});this.on("ready",function(){if(!this.fromLayer&&!this.mapID){this.showMetadataForm();}},this);var layersTabPanel=new Ext.TabPanel({border:false,deferredRender:false,items:[layersContainer,this.legendPanel],activeTab:0});var westPanel=new Ext.Panel({layout:"fit",collapseMode:"mini",split:true,items:[layersTabPanel],region:"west",width:250});var gridWinPanel=new Ext.Panel({id:'gridWinPanel',collapseMode:"mini",title:'Search Results',autoScroll:true,split:true,items:[],anchor:'100% 50%'});var gridResultsPanel=new Ext.Panel({id:'gridResultsPanel',title:'Feature Details',collapseMode:"mini",autoScroll:true,split:true,items:[],anchor:'100% 50%'});var eastPanel=new Ext.Panel({id:'queryPanel',layout:"anchor",collapseMode:"mini",split:true,items:[gridWinPanel,gridResultsPanel],collapsed:true,region:"east",width:250});this.toolbar=new Ext.Toolbar({disabled:true,items:[addLayerButton,Ext.apply(new Ext.Button(showPropertiesAction),{text:""}),this.createTools()]});this.on("ready",function(){var disabled=this.toolbar.items.filterBy(function(item){return item.initialConfig&&item.initialConfig.disabled;});this.toolbar.enable();disabled.each(function(item){item.disable();});Ext.get("request-load-pnl").hide();},this);this.googleEarthPanel=new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{"beforeadd":function(record){return record.get("group")!=="background";},"show":function(){addLayerButton.disable();removeLayerAction.disable();layerTree.getSelectionModel().un("beforeselect",updateLayerActions,this);},"hide":function(){addLayerButton.enable();updateLayerActions();layerTree.getSelectionModel().on("beforeselect",updateLayerActions,this);}}});this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,this.googleEarthPanel],activeItem:0});var header=new Ext.Panel({region:"north",autoHeight:true,contentEl:'header-wrapper'});Lang.registerLinks();this.portalItems=[header,{region:"center",xtype:"container",layout:"fit",border:false,hideBorders:true,items:{layout:"border",deferredRender:false,tbar:this.toolbar,items:[this.mapPanelContainer,westPanel,eastPanel]}}];GeoExplorer.superclass.initPortal.apply(this,arguments);if(this.config.treeconfig!=undefined)
{for(x=0;x<this.config.treeconfig.length;x++)
{if(this.config.treeconfig[x]!=null)
this.addCategoryFolder(this.config.treeconfig[x].group,this.config.treeconfig[x].expanded);}};},createStylesPanel:function(options){var layer=options.layerRecord.getLayer();var stylesPanel,stylesDialog;var createStylesDialog=function(){if(stylesPanel){stylesDialog.destroy();stylesPanel.getFooterToolbar().items.each(function(i){i.disable();});}
var modified=false;stylesDialog=this.stylesDlgCache[layer.id]=new gxp.WMSStylesDialog(Ext.apply({style:"padding: 10px 10px 0 10px;",editable:layer.url.replace(this.urlPortRegEx,"$1/").indexOf(this.localGeoServerBaseUrl.replace(this.urlPortRegEx,"$1/"))===0,plugins:[{ptype:"gx_geoserverstylewriter",baseUrl:layerUrl.split("?").shift().replace(/\/(wms|ows)\/?$/,"/rest")},{ptype:"gx_wmsrasterstylesdialog"}],autoScroll:true,listeners:Ext.apply(options.listeners||{},{"ready":function(){stylesDialog.editable===false&&stylesPanel.getFooterToolbar().hide();},"modified":function(cmp,name){stylesPanel.buttons[0].enable();stylesPanel.buttons[1].enable();layer.mergeNewParams({"STYLES":name,"SLD_BODY":cmp.createSLD({userStyles:[name]})});modified=true;},"styleselected":function(cmp,name){stylesPanel.buttons[0].enable();layer.mergeNewParams({"STYLES":name,"SLD_BODY":modified?cmp.createSLD({userStyles:[name]}):null});},"saved":function(){this.busyMask.hide();this.modified^=this.modified&2;var rec=stylesDialog.selectedStyle;var styleName=rec.get("userStyle").isDefault?"":rec.get("name");if(options.applySelectedStyle===true||styleName===initialStyle||rec.get("name")===initialStyle){layer.mergeNewParams({"STYLES":styleName,"SLD_BODY":null,"_dc":Math.random()});}
stylesPanel.ownerCt instanceof Ext.Window?stylesPanel.ownerCt.close():createStylesDialog();},scope:this})},options));if(stylesPanel){stylesPanel.add(stylesDialog);stylesPanel.doLayout();}}.bind(this);var layerUrl=layer.url;var initialStyle=layer.params.STYLES;createStylesDialog();stylesPanel=new Ext.Panel({autoHeight:true,border:false,items:stylesDialog,buttons:[{text:"Cancel",disabled:true,handler:function(){layer.mergeNewParams({"STYLES":initialStyle,"SLD_BODY":null});stylesPanel.ownerCt instanceof Ext.Window?stylesPanel.ownerCt.close():createStylesDialog();},scope:this},{text:"Save",disabled:true,handler:function(){this.busyMask=new Ext.LoadMask(stylesPanel.el,{msg:"Applying style changes..."});this.busyMask.show();stylesDialog.saveStyles();},scope:this}],listeners:{"added":function(cmp,ownerCt){ownerCt instanceof Ext.Window&&cmp.buttons[0].enable();}}});return stylesPanel;},initCapGrid:function(){var initialSourceId,source,data=[];for(var id in this.layerSources){source=this.layerSources[id];if(initialSourceId===undefined&&source instanceof gxp.plugins.WMSSource&&source.url.replace(this.urlPortRegEx,"$1/").indexOf(this.localGeoServerBaseUrl.replace(this.urlPortRegEx,"$1/"))===0){initialSourceId=id;}
if(source.store){data.push([id,this.layerSources[id].title||id]);}}
if(initialSourceId===undefined){initialSourceId=data[0][0];}
var sources=new Ext.data.ArrayStore({fields:["id","title"],data:data});var expander=new GeoExplorer.CapabilitiesRowExpander({ows:this.localGeoServerBaseUrl+"ows"});var addLocalLayers=function(){if(!this.mapID)
{Ext.Msg.alert("Save your Map View","You must save this map view before uploading your data");}
else
document.location.href="/data/upload?map="+this.mapID;};var addLayers=function(){var key=sourceComboBox.getValue();var layerStore=this.mapPanel.layers;var source=this.layerSources[key];var records=capGridPanel.getSelectionModel().getSelections();var record;for(var i=0,ii=records.length;i<ii;++i){record=source.createLayerRecord({name:records[i].get("name"),source:key,buffer:0});if(record){if(record.get("group")==="background"){var pos=layerStore.queryBy(function(rec){return rec.get("group")==="background"}).getCount();layerStore.insert(pos,[record]);}else{Ext.Ajax.request({url:"/maps/searchfields/?"+record.get("name"),method:"POST",params:{layername:record.get("name")},success:function(result,request)
{var jsonData=Ext.util.JSON.decode(result.responseText);category=jsonData.category;if(!category||category=='')
category="General";dataLayers[record.get("name")]=new LayerData(dataLayers[record.get("name")],jsonData.searchFields,category,jsonData.scount);record.set("group",category);layerStore.add([record]);},failure:function(result,request){record.set("group","General");layerStore.add([record]);}});}}}};var source=this.layerSources[initialSourceId];source.store.filterBy(function(r){return!!source.getProjection(r);},this);var capGridPanel=new Ext.grid.GridPanel({store:source.store,layout:'fit',region:'center',autoScroll:true,autoExpandColumn:"title",plugins:[expander],colModel:new Ext.grid.ColumnModel([expander,{header:"Name",dataIndex:"name",width:150,sortable:true},{id:"title",header:"Title",dataIndex:"title",sortable:true}]),listeners:{rowdblclick:addLayers,scope:this}});var sourceComboBox=new Ext.form.ComboBox({store:sources,valueField:"id",displayField:"title",triggerAction:"all",editable:false,allowBlank:false,forceSelection:true,mode:"local",value:initialSourceId,listeners:{select:function(combo,record,index){var source=this.layerSources[record.get("id")];var store=source.store;store.filterBy(function(r){return!!source.getProjection(r);},this);expander.ows=store.url;capGridPanel.reconfigure(store,capGridPanel.getColumnModel());capGridPanel.getView().focusRow(0);},scope:this}});var capGridToolbar=null;if(this.proxy||this.layerSources.getCount()>1){capGridToolbar=[new Ext.Toolbar.TextItem({text:this.layerSelectionLabel}),sourceComboBox];}
if(this.proxy){capGridToolbar.push(new Ext.Button({text:this.layerAdditionLabel,handler:function(){newSourceWindow.show();}}));}
capGridToolbar.push({xtype:'tbspacer',width:50});capGridToolbar.push("->")
capGridToolbar.push(new Ext.Button({text:this.layerLocalLabel,iconCls:'icon-add',handler:addLocalLayers,cls:'x-btn-link-medium',scope:this}));capGridToolbar.width=600;var app=this;var newSourceWindow=new gxp.NewSourceWindow({modal:true,listeners:{"server-added":function(url){newSourceWindow.setLoading();this.addLayerSource({config:{url:url},callback:function(id){var record=new sources.recordType({id:id,title:this.layerSources[id].title||"Untitled"});sources.insert(0,[record]);sourceComboBox.onSelect(record,0);newSourceWindow.hide();},failure:function(){newSourceWindow.setError("Error contacting server.\nPlease check the url and try again.");},scope:this});},scope:this},addSource:function(url,success,failure,scope){app.busyMask=scope.loadMask;}});this.capGrid=new Ext.Window({title:this.capGridText,closeAction:'hide',layout:'border',height:300,width:600,modal:true,items:[capGridPanel],tbar:capGridToolbar,bbar:["->",new Ext.Button({text:this.capGridAddLayersText,iconCls:"icon-addlayers",handler:addLayers,scope:this}),new Ext.Button({text:this.capGridDoneText,handler:function(){this.capGrid.hide();},scope:this})],listeners:{hide:function(win){capGridPanel.getSelectionModel().clearSelections();}}});},showCapabilitiesGrid:function(){if(!this.capGrid){this.initCapGrid();}
this.capGrid.show();},createLogoOverlay:function(){var cgaLogo=new Ext.BoxComponent({autoEl:{tag:"div",cls:"cga-logo-overlay-element"}});return cgaLogo;},createMapOverlay:function(){var scaleLinePanel=new Ext.BoxComponent({autoEl:{tag:"div",cls:"olControlScaleLine overlay-element overlay-scaleline"}});scaleLinePanel.on('render',function(){var scaleLine=new OpenLayers.Control.ScaleLine({div:scaleLinePanel.getEl().dom,geodesic:true});this.mapPanel.map.addControl(scaleLine);scaleLine.activate();},this);var zoomSelectorWrapper=new Ext.Panel({cls:'overlay-element overlay-scalechooser',border:false});this.on("ready",function(){var zoomStore=new GeoExt.data.ScaleStore({map:this.mapPanel.map});var zoomSelector=new Ext.form.ComboBox({emptyText:this.zoomSelectorText,tpl:'<tpl for="."><div class="x-combo-list-item">1 : {[parseInt(values.scale)]}</div></tpl>',editable:false,triggerAction:'all',mode:'local',store:zoomStore,width:110});zoomSelector.on({click:function(evt){evt.stopEvent();},mousedown:function(evt){evt.stopEvent();},select:function(combo,record,index){this.mapPanel.map.zoomTo(record.data.level);},scope:this});function setScale(){var scale=zoomStore.queryBy(function(record){return this.mapPanel.map.getZoom()==record.data.level;},this);if(scale.length>0){scale=scale.items[0];zoomSelector.setValue("1 : "+parseInt(scale.data.scale,10));}else{if(!zoomSelector.rendered){return;}
zoomSelector.clearValue();}}
setScale.call(this);this.mapPanel.map.events.register('zoomend',this,setScale);zoomSelectorWrapper.add(zoomSelector);zoomSelectorWrapper.doLayout();},this);var mapOverlay=new Ext.Panel({cls:'map-overlay',items:[scaleLinePanel,zoomSelectorWrapper]});mapOverlay.on("afterlayout",function(){scaleLinePanel.getEl().dom.style.position='relative';scaleLinePanel.getEl().dom.style.display='inline';mapOverlay.getEl().on("click",function(x){x.stopEvent();});mapOverlay.getEl().on("mousedown",function(x){x.stopEvent();});},this);return mapOverlay;},createTools:function(){var toolGroup="toolGroup";var mapPanel=this.mapPanel;var busyMask=null;var keywords=this.about["keywords"]?this.about["keywords"]:"of";var picasaRecord=null;var createPicasaOverlay=function()
{picasaConfig={name:"Picasa",source:"0",group:"Overlays",buffer:"0",type:"OpenLayers.Layer.WFS",args:["Picasa Pictures","/picasa/",{'kind':'photo','max-results':'50','q':keywords},{format:OpenLayers.Format.GeoRSS,projection:"EPSG:4326",displayInLayerSwitcher:false,formatOptions:{createFeatureFromItem:function(item){var feature=OpenLayers.Format.GeoRSS.prototype.createFeatureFromItem.apply(this,arguments);feature.attributes.thumbnail=this.getElementsByTagNameNS(item,"http://search.yahoo.com/mrss/","thumbnail")[0].getAttribute("url");feature.attributes.content=OpenLayers.Util.getXmlNodeValue(this.getElementsByTagNameNS(item,"*","summary")[0]);return feature;}},styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({externalGraphic:"${thumbnail}",pointRadius:14}),"select":new OpenLayers.Style({pointRadius:20})})}]};feedSource=Ext.ComponentMgr.createPlugin(picasaConfig,"gx_olsource");picasaRecord=feedSource.createLayerRecord(picasaConfig);picasaRecord.group=picasaConfig.group;popupControl=new OpenLayers.Control.SelectFeature(picasaRecord.getLayer(),{clickout:true,onSelect:function(feature){var pos=feature.geometry;popup=new OpenLayers.Popup("popup",new OpenLayers.LonLat(pos.x,pos.y),new OpenLayers.Size(160,160),"<a target='_blank' href="+
$(feature.attributes.content).find("a").attr("href")+"><img title='"+
feature.attributes.title+"' src='"+feature.attributes.thumbnail+"' /></a>",false);popup.closeOnMove=true;popup.keepInMap=true;mapPanel.map.addPopup(popup);},onUnselect:function(feature){mapPanel.map.removePopup(popup);popup=null;}});mapPanel.map.addControl(popupControl);popupControl.activate();return picasaRecord;};var youtubeRecord=null;var createYouTubeOverlay=function()
{youtubeConfig={name:"YouTube",source:"0",group:"Overlays",buffer:"0",type:"OpenLayers.Layer.WFS",args:["YouTube Videos","/youtube/",{'max-results':'50','q':'africa','bbox':mapPanel.map.getExtent().transform(mapPanel.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")).toBBOX()},{format:OpenLayers.Format.GeoRSS,projection:"EPSG:4326",displayInLayerSwitcher:false,formatOptions:{createFeatureFromItem:function(item){var feature=OpenLayers.Format.GeoRSS.prototype.createFeatureFromItem.apply(this,arguments);feature.attributes.thumbnail=this.getElementsByTagNameNS(item,"http://search.yahoo.com/mrss/","thumbnail")[4].getAttribute("url");feature.attributes.content=OpenLayers.Util.getXmlNodeValue(this.getElementsByTagNameNS(item,"*","summary")[0]);return feature;}},styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({externalGraphic:"${thumbnail}",pointRadius:24}),"select":new OpenLayers.Style({pointRadius:30})})}]};feedSource=Ext.ComponentMgr.createPlugin(youtubeConfig,"gx_olsource");youtubeRecord=feedSource.createLayerRecord(youtubeConfig);youtubeRecord.group=youtubeConfig.group;popupControl=new OpenLayers.Control.SelectFeature(youtubeRecord.getLayer(),{clickout:true,onSelect:function(feature){var pos=feature.geometry;popup=new OpenLayers.Popup("popup",new OpenLayers.LonLat(pos.x,pos.y),new OpenLayers.Size(240,180),"<a target='_blank' href="+
feature.attributes.link+"><img height='180', width='240' title='"+
feature.attributes.title+"' src='"+feature.attributes.thumbnail+"' /></a>",false);popup.closeOnMove=true;popup.keepInMap=true;mapPanel.map.addPopup(popup);},onUnselect:function(feature){mapPanel.map.removePopup(popup);popup=null;}});mapPanel.map.addControl(popupControl);popupControl.activate();return youtubeRecord;};var printButton=new Ext.Button({tooltip:this.printTipText,iconCls:"icon-print",handler:function(){var unsupportedLayers=[];var printWindow=new Ext.Window({title:this.printWindowTitleText,modal:true,border:false,autoHeight:true,resizable:false,items:[{xtype:"gxux_printpreview",mapTitle:this.about["title"],comment:this.about["abstract"],minWidth:336,printMapPanel:{height:Math.min(450,Ext.get(document.body).getHeight()-150),autoWidth:true,limitScales:true,map:{controls:[new OpenLayers.Control.Navigation({zoomWheelEnabled:false,zoomBoxEnabled:false}),new OpenLayers.Control.PanPanel(),new OpenLayers.Control.Attribution()],eventListeners:{"preaddlayer":function(evt){if(evt.layer instanceof OpenLayers.Layer.Google){unsupportedLayers.push(evt.layer.name);return false;}},scope:this}}},printProvider:{capabilities:window.printCapabilities,listeners:{"beforeprint":function(){printWindow.items.get(0).printMapPanel.layers.each(function(l){var params=l.getLayer().params;for(var p in params){if(params[p]instanceof Array){params[p]=params[p].join(",");}}})},"print":function(){printWindow.close();},"printException":function(cmp,response){this.displayXHRTrouble(response);},scope:this}},includeLegend:true,sourceMap:this.mapPanel,legend:this.legendPanel}]}).show();printWindow.center();unsupportedLayers.length&&Ext.Msg.alert(this.unsupportedLayersTitleText,this.unsupportedLayersText+"<ul><li>"+unsupportedLayers.join("</li><li>")+"</li></ul>");},scope:this});var navAction=new GeoExt.Action({tooltip:this.navActionTipText,iconCls:"icon-pan",enableToggle:true,pressed:true,allowDepress:false,control:new OpenLayers.Control.Navigation(),map:this.mapPanel.map,toggleGroup:toolGroup});var historyControl=new OpenLayers.Control.NavigationHistory();this.mapPanel.map.addControl(historyControl);var navPreviousAction=new GeoExt.Action({tooltip:this.navPreviousActionText,iconCls:"icon-zoom-previous",disabled:true,control:historyControl.previous});var navNextAction=new GeoExt.Action({tooltip:this.navNextAction,iconCls:"icon-zoom-next",disabled:true,control:historyControl.next});var info={controls:[]};var infoButton=new Ext.Button({tooltip:this.infoButtonText,iconCls:"icon-getfeatureinfo",handler:this.showInfoWindow,scope:this});var picasaButton=new Ext.Button({enableToggle:true,allowDepress:true,iconCls:"icon-picasa",scope:this,toggleHandler:function(button,pressed){if(pressed){if(picasaRecord==null){createPicasaOverlay();this.mapPanel.layers.insert(mapPanel.layers.data.items.length,[picasaRecord]);}
else{this.mapPanel.map.setLayerIndex(picasaRecord.getLayer(),mapPanel.layers.data.items.length);picasaRecord.getLayer().setVisibility(true);}}else{picasaRecord.getLayer().setVisibility(false);}}});var youtubeButton=new Ext.Button({enableToggle:true,allowDepress:true,iconCls:"icon-youtube",toggleHandler:function(button,pressed){if(pressed){if(youtubeRecord==null){createYouTubeOverlay();mapPanel.layers.insert(mapPanel.layers.data.items.length,[youtubeRecord]);}
else{mapPanel.map.setLayerIndex(youtubeRecord.getLayer(),mapPanel.layers.data.items.length);youtubeRecord.getLayer().setVisibility(true);}}else{youtubeRecord.getLayer().setVisibility(false);}}});var searchTB=new Ext.form.TextField({id:'search-tb',width:200,emptyText:'Enter search...'});var psHandler=function(){performSearch.call();};var searchBtn=new Ext.Button({text:'Search',handler:psHandler});var performSearch=function(){var searchCount=0;var queryableLayers=mapPanel.layers.queryBy(function(x){return x.get("queryable");});queryableLayers.each(function(x){dl=x.getLayer();if(!dl.getVisibility()||dataLayers[dl.params.LAYERS].count==0)
{queryableLayers.remove(x);}});if(queryableLayers.length==0)
{Ext.MessageBox.alert('No Searchable Layers','There are currently no searchable layers on the map.  You must have at least one visible layer with searchable fields on the map.');return;}
if(!busyMask){busyMask=new Ext.LoadMask(mapPanel.map.div,{msg:'Searching...'});}
busyMask.show();try{removeHighlightLayers();searchTerm=searchTB.getValue();var terms=[];var matchingSearchTerm=searchTerm;var re=/("[^"]+")/g;var m=matchingSearchTerm.match(re);var otherSearchTerm=searchTerm;if(m!=null){for(i=0;i<m.length;i++){otherSearchTerm=otherSearchTerm.replace(m[i],'');terms.push(m[i].replace(/"/g,''));}}else{}
var whitespace_re=/\s+/;otherSearchTerm=otherSearchTerm.replace(whitespace_re,' ');terms=terms.concat(otherSearchTerm.split(' '));layers=[];queryableLayers.each(function(x){dl=x.getLayer();if(dl.getVisibility())
{var wms_url=dl.url;queryFields=[];for(f=0;f<dataLayers[dl.params.LAYERS].searchFields.length;f++)
{field=dataLayers[dl.params.LAYERS].searchFields[f]
if(field.searchable=="True"){queryFields.push(field.attribute);}}
featureQuery="";sld='';sld+='<sld:StyledLayerDescriptor xmlns="http://www.opengis.net/sld" xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" version="1.0.0">';sld+='<sld:NamedLayer><sld:Name>'+dl.params.LAYERS+'</sld:Name><sld:UserStyle><sld:Name>query</sld:Name><sld:FeatureTypeStyle><sld:Rule><ogc:Filter>';for(i=0;i<queryFields.length;i++)
{if(queryFields[i]!="")
featureQuery=featureQuery+'<ogc:PropertyIsLike wildCard="*" singleChar="." escapeChar="!"><ogc:PropertyName>'+queryFields[i]+'</ogc:PropertyName><ogc:Literal>*'+searchTerm+'*</ogc:Literal></ogc:PropertyIsLike>';}
if(queryFields.length>1)
{featureQuery="<ogc:Or>"+featureQuery+"</ogc:Or>";}
if(featureQuery.length>0)
{sld+=featureQuery;sld+='</ogc:Filter>';sld+='<PointSymbolizer><Graphic><Mark><WellKnownName>circle</WellKnownName><Fill><CssParameter name="fill">#FFFF00</CssParameter></Fill></Mark><Size>8</Size></Graphic></PointSymbolizer>';sld+='<LineSymbolizer><sld:Stroke><sld:CssParameter name="stroke">#FFFF00</sld:CssParameter><sld:CssParameter name="stroke-opacity">1.0</sld:CssParameter><sld:CssParameter name="stroke-width">2</sld:CssParameter></sld:Stroke></LineSymbolizer>';sld+='<sld:PolygonSymbolizer> <sld:Fill><sld:GraphicFill> <sld:Graphic><sld:Mark> <sld:WellKnownName>shape://times</sld:WellKnownName> <sld:Stroke><sld:CssParameter name="stroke">#FFFF00</sld:CssParameter>';sld+='<sld:CssParameter name="stroke-width">1</sld:CssParameter> </sld:Stroke></sld:Mark><sld:Size>16</sld:Size> </sld:Graphic></sld:GraphicFill> </sld:Fill></sld:PolygonSymbolizer>';sld+='</sld:Rule></sld:FeatureTypeStyle></sld:UserStyle></sld:NamedLayer></sld:StyledLayerDescriptor>';wmsHighlight=new OpenLayers.Layer.WMS("HighlightWMS",wms_url,{'layers':dl.params.LAYERS,'format':'image/png',SLD_BODY:sld,TRANSPARENT:'true'},{'isBaseLayer':false,'displayInLayerSwitcher':false});layers.push(wmsHighlight);}}});mapPanel.map.addLayers(layers);}catch(e){}finally{if(busyMask){busyMask.hide();}}};var reset=function(){searchTB.setValue('');removeHighlightLayers();};var removeHighlightLayers=function(){var theLayers=mapPanel.map.layers;var hLayers=[];for(l=0;l<theLayers.length;l++)
{if(theLayers[l].name=="HighlightWMS"){hLayers.push(theLayers[l]);}}
for(h=0;h<hLayers.length;h++)
{mapPanel.map.removeLayer(hLayers[h]);}}
var searchBar=new Ext.Toolbar({id:'tlbr',items:[' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','-',searchTB,' ',searchBtn,' ',{xtype:'button',text:'Reset',handler:function(brn,e){reset();}},' ','-',{id:'request-load-pnl',xtype:'panel',html:'<img src="images/ajax-loader.gif" alt="Request loading...">'}]});var jumpstore=new Ext.data.SimpleStore({fields:['dataFieldName','displayFieldName'],data:[[0,'Yelp'],[1,'Bing Map'],[2,'Social Explorer']],autoLoad:false});var jumpBar=new Ext.Toolbar({id:'jumpbar',items:[{xtype:'label',html:'<div style="color:#653117">&nbsp; Jump To:  &nbsp;</div>'},{xtype:'combo',store:jumpstore,displayField:'displayFieldName',valueField:'dataFieldName',typeAhead:true,forceSelection:true,fieldLabel:'ComboBox',emptyText:'Select a Web Site...',mode:'local',triggerAction:'all',selectOnFocus:true,editable:true,listeners:{select:function(combo,record,index){displayProjection=new OpenLayers.Projection("EPSG:4326");if(record.data.dataFieldName==0)
{var bounds=mapPanel.map.getExtent();var extents=bounds.transform(mapPanel.map.getProjectionObject(),displayProjection);window.open('http://www.yelp.com/search?find_desc=&ns=1&rpp=10#l=g:'+extents.left+'%2C'+extents.bottom+'%2C'+extents.right+'%2C'+extents.top+'&sortby=category');}
else if(record.data.dataFieldName==1){var point=mapPanel.map.getCenter();var lonlat=point.transform(mapPanel.map.getProjectionObject(),displayProjection);window.open('http://www.bing.com/maps/default.aspx?v=2&FORM=LMLTCP&cp='+lonlat.lat+'~'+lonlat.lon+'&style=r&lvl='+mapPanel.map.getZoom()+'&tilt=-90&dir=0&alt=-1000&phx=0&phy=0&phscl=1&encType=1');}
else if(record.data.dataFieldName==2){var bounds=mapPanel.map.getExtent();var extents=bounds.transform(mapPanel.map.getProjectionObject(),displayProjection);window.open('http://www.socialexplorer.com/pub/maps/map3.aspx?g=0&mapi=SE0012&themei=B23A1CEE3D8D405BA2B079DDF5DE9402&l='+ConvertLonToAlbersEqArea(extents.left)+'&r='+ConvertLonToAlbersEqArea(extents.right)+'&t='+ConvertLatToAlbersEqArea(extents.top)+'&b='+ConvertLatToAlbersEqArea(extents.bottom)+'&rndi=1');}else{}}}}]});var addInfo=function(){var queryableLayers=this.mapPanel.layers.queryBy(function(x){return x.get("queryable");});var geoEx=this;var control;for(var i=0,len=info.controls.length;i<len;i++){control=info.controls[i];control.deactivate();control.destroy();}
info.controls=[];queryableLayers.each(function(x){var dl=x.getLayer();if(dl.name!="HighlightWMS"){Ext.Ajax.request({url:"/maps/searchfields/?"+dl.params.LAYERS,method:"POST",params:{layername:dl.params.LAYERS},success:function(result,request)
{var jsonData=Ext.util.JSON.decode(result.responseText);layerfields=jsonData.searchFields;category=x.get("group")!=""&&x.get("group")!=undefined&&x.get("group")?x.get("group"):jsonData.category;if(category=="")
category="General";x.set("group",category);dataLayers[dl.params.LAYERS]=new LayerData(dl.params.LAYERS,jsonData.searchFields,category,jsonData.scount);geoEx.addCategoryFolder(category,"true");},failure:function(result,request){alert(result.responseText);}});}},this);};var updateInfo=function(){var queryableLayers=this.mapPanel.layers.queryBy(function(x){return x.get("queryable");});var map=this.mapPanel.map;var control;for(var i=0,len=info.controls.length;i<len;i++){control=info.controls[i];control.deactivate();control.destroy();}
info.controls=[];};this.mapPanel.layers.on("update",updateInfo,this);this.mapPanel.layers.on("add",addInfo,this);this.mapPanel.layers.on("remove",updateInfo,this);var activeIndex=0;var measureSplit=new Ext.SplitButton({iconCls:"icon-measure-length",tooltip:this.measureSplitText,enableToggle:true,toggleGroup:toolGroup,allowDepress:false,handler:function(button,event){if(!button.pressed){button.toggle();}else{button.menu.items.itemAt(activeIndex).setChecked(true);}},listeners:{toggle:function(button,pressed){if(!pressed){button.menu.items.each(function(i){i.setChecked(false);});}},render:function(button){Ext.ButtonToggleMgr.register(button);}},menu:new Ext.menu.Menu({items:[new Ext.menu.CheckItem(new GeoExt.Action({text:this.lengthActionText,iconCls:"icon-measure-length",map:this.mapPanel.map,toggleGroup:toolGroup,group:toolGroup,allowDepress:false,map:this.mapPanel.map,control:this.createMeasureControl(OpenLayers.Handler.Path,"Length")})),new Ext.menu.CheckItem(new GeoExt.Action({text:this.areaActionText,iconCls:"icon-measure-area",map:this.mapPanel.map,toggleGroup:toolGroup,group:toolGroup,allowDepress:false,map:this.mapPanel.map,control:this.createMeasureControl(OpenLayers.Handler.Polygon,"Area")}))]})});measureSplit.menu.items.each(function(item,index){item.on({checkchange:function(item,checked){measureSplit.toggle(checked);if(checked){activeIndex=index;measureSplit.setIconClass(item.iconCls);}}});});var enable3DButton=new Ext.Button({iconCls:"icon-3D",tooltip:this.switchTo3DActionText,enableToggle:true,toggleHandler:function(button,state){if(state===true){this.mapPanelContainer.getLayout().setActiveItem(1);this.toolbar.disable();button.enable();}else{this.mapPanelContainer.getLayout().setActiveItem(0);this.toolbar.enable();}},scope:this});var advancedToolsLink=function(){if(!this.mapID)
{Ext.Msg.alert("Save your Map View","You must save this map view before using advanced map tools");}
else
document.location.href="/maps/"+this.mapID+"/edit";};var tools=[new Ext.Button({tooltip:this.saveMapText,handler:this.showMetadataForm,scope:this,iconCls:"icon-save"}),new Ext.Action({tooltip:this.publishActionText,handler:this.makeExportDialog,scope:this,iconCls:'icon-export',disabled:!this.mapID}),window.printCapabilities?printButton:"","-",navPreviousAction,navNextAction,new Ext.Button({tooltip:this.zoomVisibleButtonText,iconCls:"icon-zoom-visible",handler:function(){this.mapPanel.map.setCenter(this.initialConfig.map["center"]);this.mapPanel.map.zoomTo(this.initialConfig.map["zoom"]);},scope:this}),enable3DButton,infoButton,picasaButton,youtubeButton,searchBar,jumpBar,'->',new Ext.Button({text:'Advanced map tools',handler:advancedToolsLink,cls:'x-btn-link-medium',scope:this})];this.on("saved",function(){tools[1].enable();this.modified^=this.modified&1;},this);return tools;},createMeasureControl:function(handlerType,title){var styleMap=new OpenLayers.StyleMap({"default":new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{"Point":{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},"Line":{strokeWidth:3,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},"Polygon":{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",fillColor:"white",fillOpacity:0.3}}})]})});var cleanup=function(){if(measureToolTip){measureToolTip.destroy();}};var makeString=function(metricData){var metric=metricData.measure;var metricUnit=metricData.units;measureControl.displaySystem="english";var englishData=metricData.geometry.CLASS_NAME.indexOf("LineString")>-1?measureControl.getBestLength(metricData.geometry):measureControl.getBestArea(metricData.geometry);var english=englishData[0];var englishUnit=englishData[1];measureControl.displaySystem="metric";var dim=metricData.order==2?'<sup>2</sup>':'';return metric.toFixed(2)+" "+metricUnit+dim+"<br>"+
english.toFixed(2)+" "+englishUnit+dim;};var measureToolTip;var measureControl=new OpenLayers.Control.Measure(handlerType,{persist:true,handlerOptions:{layerOptions:{styleMap:styleMap}},eventListeners:{measurepartial:function(event){cleanup();measureToolTip=new Ext.ToolTip({target:Ext.getBody(),html:makeString(event),title:title,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:cleanup}});if(event.measure>0){var px=measureControl.handler.lastUp;var p0=this.mapPanel.getPosition();measureToolTip.targetXY=[p0[0]+px.x,p0[1]+px.y];measureToolTip.show();}},measure:function(event){cleanup();measureToolTip=new Ext.ToolTip({target:Ext.getBody(),html:makeString(event),title:title,autoHide:false,closable:true,draggable:false,mouseOffset:[0,0],showDelay:1,listeners:{hide:function(){measureControl.cancel();cleanup();}}});},deactivate:cleanup,scope:this}});return measureControl;},makeExportDialog:function(){new Ext.Window({title:this.publishActionText,layout:"fit",width:380,autoHeight:true,items:[{xtype:"gx_embedmapdialog",url:this.rest+this.mapID+"/embed"}]}).show();},displayPopup:function(evt,title){GeoExplorer.Search.displayXYResults(evt);},initMetadataForm:function(){var titleField=new Ext.form.TextField({width:'95%',fieldLabel:this.metaDataMapTitle,value:this.about.title,allowBlank:false,enableKeyEvents:true,listeners:{"valid":function(){saveAsButton.enable();saveButton.enable();},"invalid":function(){saveAsButton.disable();saveButton.disable();}}});Ext.apply(Ext.form.VTypes,{UniqueMapId:this.mapID,UniqueUrl:function(value,field){var allowedChars=value.match(/^(\w+[-]*)+$/g);if(!allowedChars){this.UniqueUrlText="URL's can only contain letters, numbers, dashes & underscores."
return false;}
Ext.Ajax.request({url:"/maps/checkurl/",method:'POST',params:{query:value,mapid:this.UniqueMapId},success:function(response,options){var urlcount=Ext.decode(response.responseText).count;if(urlcount>0){this.UniqueUrlText="The following URL's are already taken:";var urls=Ext.decode(response.responseText).urls;var isValid=true;for(var u in urls){if(urls[u].url!=undefined&&urls[u].url!=null)
this.UniqueUrlText+="<br/>"+urls[u].url;if(urls[u].url==value){isValid=false;}}
if(!isValid)
field.markInvalid(this.UniqueUrlText);}},failure:function(response,options)
{return false;Ext.Msg.alert('Error',response.responseText,this.showMetadataForm);},scope:this});return true;},UniqueUrlText:"The following URL's are already taken, please choose another"});var urlField=new Ext.form.TextField({width:'30%',fieldLabel:this.metaDataMapUrl+"<br/><span style='font-style:italic;'>http://"+document.location.hostname+"/maps/</span>",labelSeparator:'',enableKeyEvents:true,validationEvent:'onblur',vtype:'UniqueUrl',itemCls:'x-form-field-inline',ctCls:'x-form-field-inline',value:this.about["urlsuffix"]});var abstractField=new Ext.form.TextArea({width:'95%',height:50,fieldLabel:this.metaDataMapAbstract,value:this.about["abstract"]});var keywordsField=new Ext.form.TextField({width:'95%',fieldLabel:this.metaDataMapKeywords,value:this.about["keywords"]});var introTextField=new Ext.form.HtmlEditor({width:'95%',height:200,fieldLabel:this.metaDataMapIntroText,value:this.about["introtext"]});var metaDataPanel=new Ext.FormPanel({bodyStyle:{padding:"5px"},labelAlign:"top",items:[titleField,urlField,abstractField,keywordsField,introTextField]});metaDataPanel.enable();var saveAsButton=new Ext.Button({text:this.metadataFormSaveAsCopyText,disabled:!this.about.title,handler:function(e){this.about.title=titleField.getValue();this.about["abstract"]=abstractField.getValue();this.about["urlsuffix"]=urlField.getValue();this.about["introtext"]=introTextField.getValue();this.about["keywords"]=keywordsField.getValue();this.save(true);this.initInfoTextWindow();},scope:this});var saveButton=new Ext.Button({text:this.metadataFormSaveText,disabled:!this.about.title,handler:function(e){this.about.title=titleField.getValue();this.about["abstract"]=abstractField.getValue();this.about["urlsuffix"]=urlField.getValue();this.about["introtext"]=introTextField.getValue();this.about["keywords"]=keywordsField.getValue();this.save();this.initInfoTextWindow();},scope:this});this.metadataForm=new Ext.Window({title:this.metaDataHeader,closeAction:'hide',items:metaDataPanel,modal:true,width:600,autoHeight:true,bbar:["->",saveAsButton,saveButton,new Ext.Button({text:this.metadataFormCancelText,handler:function(){titleField.setValue(this.about.title);abstractField.setValue(this.about["abstract"]);urlField.setValue(this.about["urlsuffix"]);introTextField.setValue(this.about["introtext"]);keywordsField.setValue(this.about["keywords"]);this.metadataForm.hide();},scope:this})]});},initInfoTextWindow:function(){this.infoTextPanel=new Ext.FormPanel({bodyStyle:{padding:"5px"},labelAlign:"top",preventBodyReset:true,autoScroll:true,autoHeight:true,html:this.about['introtext']});this.infoTextPanel.enable();this.infoTextWindow=new Ext.Window({title:this.about.title,closeAction:'hide',items:this.infoTextPanel,modal:true,width:600,height:600,autoScroll:true});},showInfoWindow:function(){if(!this.infoTextWindow){this.initInfoTextWindow();}
this.infoTextWindow.show();},showMetadataForm:function(){if(!this.metadataForm){this.initMetadataForm();}
this.metadataForm.show();},updateURL:function(){return this.rest+this.mapID+'/data';},save:function(as){for(var id in this.stylesDlgCache){this.stylesDlgCache[id].saveStyles();}
var config=this.getState();var treeConfig=[];for(x=0;x<this.treeRoot.firstChild.childNodes.length;x++)
{node=this.treeRoot.firstChild.childNodes[x];treeConfig.push({group:node.text,expanded:node.expanded.toString()});}
config.treeconfig=treeConfig;if(!this.mapID||as){Ext.Ajax.request({url:this.rest,method:'POST',jsonData:config,success:function(response,options){var id=response.getResponseHeader("Location");id=id.replace(/^\s*/,'');id=id.replace(/\s*$/,'');id=id.match(/[\d]*$/)[0];this.mapID=id;this.fireEvent("saved",id);this.metadataForm.hide();},scope:this});}
else{Ext.Ajax.request({url:this.updateURL(),method:'PUT',jsonData:config,success:function(response,options){this.fireEvent("saved",this.mapID);this.metadataForm.hide();},failure:function(response,options)
{Ext.Msg.alert('Error',response.responseText,this.showMetadataForm);},scope:this});}}});GeoExplorer.Results={gridWin:null,hilites:null,resultWin:null,currentFeatures:[],gridMarker:null,resultMarker:null,target:null,reset:function(){var theLayers=this.target.mapPanel.map.layers;var hLayers=[];for(l=0;l<theLayers.length;l++)
{if(theLayers[l].name=="hilites"){this.target.mapPanel.map.removeLayer(theLayers[l]);break;}}},displayXYResults:function(featureInfo,featureMeta,lonlat){var ep=Ext.getCmp('queryPanel');var gp=Ext.getCmp('gridWinPanel');ep.expand(true);gp.removeAll(true);var currentFeatures=featureInfo;var reader=new Ext.data.JsonReader({},[{name:'wm_layer_title'},{name:'wm_layer_name'},{name:'wm_layer_id'},{name:'wm_layer_type'}]);var winWidth=450;var startX=50;var gridPanel=new Ext.grid.GridPanel({store:new Ext.data.GroupingStore({reader:reader,data:currentFeatures,sortInfo:{field:'wm_layer_name',direction:"ASC"},groupField:'wm_layer_title'}),columns:[{id:'wm_layer_id',sortable:false,header:'FID',dataIndex:'wm_layer_id',hidden:true},{header:'Name',sortable:true,dataIndex:'wm_layer_name',width:190},{header:'Feature Type',dataIndex:'wm_layer_type',width:0,hidden:true},{header:'Layer',sortable:false,dataIndex:'wm_layer_title',width:0,hidden:true}],view:new Ext.grid.GroupingView({groupTextTpl:'{group}',style:'width: 425px'}),sm:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{rowselect:{fn:function(sm,rowIndex,rec){GeoExplorer.Results.displaySingleResult(currentFeatures,rowIndex,rec.data,featureMeta[rec.data.wm_layer_type]);}}}}),layout:'fit',frame:false,collapsible:true,title:'',iconCls:'icon-grid',autoHeight:true,style:'width: 425px',width:'400'});gp.add(gridPanel);gp.doLayout();gridPanel.getSelectionModel().selectFirstRow();},displaySingleResult:function(currentFeatures,rowIndex,gridFeature,metaColumns){var dp=Ext.getCmp('gridResultsPanel');dp.removeAll();var feature=null;for(var i=0;i<currentFeatures.length;i++){if(currentFeatures[i].wm_layer_id==gridFeature.wm_layer_id){feature=currentFeatures[i];}}
if(!feature){return;}
this.addVectorQueryLayer(feature);var featureHtml=this.createHTML(feature,metaColumns);dp.update(featureHtml);dp.doLayout();},createHTML:function(feature,metaColumns){html='<ul class="featureDetailList" id="featureDetailList">';for(c=0;c<metaColumns.length;c++)
{column=metaColumns[c];html+="<li><label>"+column.label+"</label><span>"+feature.attributes[column.attribute]+"</span></li>";}
html+="</ul>";return html;},addVectorQueryLayer:function(feature)
{var highlight_style={strokeColor:'Red',strokeWidth:4,strokeOpacity:1,fillOpacity:0.0,pointRadius:10};this.reset();hilites=new OpenLayers.Layer.Vector("hilites",{isBaseLayer:false,visibility:true,style:highlight_style,displayInLayerSwitcher:false});hilites.addFeatures(feature);hilites.setVisibility(true);this.target.mapPanel.map.addLayers([hilites]);return hilites;}}
Ext.namespace("GeoExplorer");GeoExplorer.Viewer=Ext.extend(GeoExplorer,{initPortal:function(){if(this.useMapOverlay!==false){this.mapPanel.add(this.createMapOverlay());}
if(this.useToolbar!==false){this.toolbar=new Ext.Toolbar({xtype:"toolbar",region:"north",autoHeight:true,disabled:true,items:this.createTools()});this.on("ready",function(){this.toolbar.enable();},this);}
this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",tbar:this.toolbar,defaults:{border:false},items:[this.mapPanel,new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(record){return record.get("group")!=="background";}}})],activeItem:0});this.portalItems=[this.mapPanelContainer];GeoExplorer.superclass.initPortal.apply(this,arguments);},addLayerSource:function(options){var source=GeoExplorer.superclass.addLayerSource.apply(this,arguments);},createTools:function(){var tools=GeoExplorer.Viewer.superclass.createTools.apply(this,arguments);var layerChooser=new Ext.Button({tooltip:'Layer Switcher',iconCls:'icon-layer-switcher',menu:new gxp.menu.LayerMenu({layers:this.mapPanel.layers})});tools.unshift("-");tools.unshift(layerChooser);var aboutButton=new Ext.Button({tooltip:"About this map",iconCls:"icon-about",handler:this.displayAppInfo,scope:this});tools.push("->");tools.push(aboutButton);return tools;}});function ConvertLonToAlbersEqArea(dLon)
{return roundNumber(87832.461034585*(dLon+100),2);};function ConvertLatToAlbersEqArea(dLat)
{var e=0.0818191955335;var es=.00669438075774911;var one_es=0.993305619242251;var k0=.0000001237057815;var pi=3.14159265358979;var dRadsLat=(pi*dLat)/180;var dSinLat=Math.sin(dRadsLat);var dCon=e*dSinLat;return roundNumber(0.5*(one_es*(dSinLat/(1-dCon*dCon)-(0.5/e)*Math.log((1-dCon)/(1+dCon))))/k0,2);};function roundNumber(rnum,rlength)
{if(rnum>8191&&rnum<10485)
{rnum=rnum-5000;var newnumber=Math.round(rnum*Math.pow(10,rlength))/Math.pow(10,rlength);return newnumber+5000;}
else
return Math.round(rnum*Math.pow(10,rlength))/Math.pow(10,rlength);};Ext.namespace("GeoExplorer");GeoExplorer.CapabilitiesRowExpander=Ext.extend(Ext.grid.RowExpander,{categoryText:"UT:Category:",categoryEmptyText:"UT:No category is provided for this layer.",abstractText:"UT:Abstract:",attributionEmptyText:"UT: No attribution information is provided for this layer.",attributionText:"UT:Provided by:",downloadText:"UT:Download:",keywordEmptyText:"UT: No keywords are listed for this layer.",keywordText:"UT:Keywords:",metadataEmptyText:'UT: No metadata URLs are defined for this layer.',metadataText:"UT:Metadata Links:",ows:null,constructor:function(config){config=config||{};config.tpl=config.tpl||this.getDefaultTemplate();var expander,templateLib;expander=this;templateLib=Ext.apply({ows:function(){return expander.ows;}},this.templateLibrary);templateLib.metadataEmptyText=this.metadataEmptyText;templateLib.keywordEmptyText=this.keywordEmptyText;templateLib.attributionEmptyText=this.attributionEmptyText;Ext.apply(config.tpl,templateLib);GeoExplorer.CapabilitiesRowExpander.superclass.constructor.call(this,config);this.on("beforeexpand",function(expander,record,body,rowIndex){var store=record.store
if(store instanceof GeoExt.data.WMSCapabilitiesStore){var request=store.reader.raw.capability.request.describelayer;request&&Ext.Ajax.request({url:request.href,params:{"REQUEST":"DescribeLayer","VERSION":store.reader.raw.version,"LAYERS":record.get("layer").params.LAYERS},disableCaching:false,success:function(response){var describeLayer=new OpenLayers.Format.WMSDescribeLayer().read(response.responseXML&&response.responseXML.documentElement?response.responseXML:response.responseText);if(describeLayer.length&&describeLayer[0].owsType==="WFS"){Ext.get(Ext.query(".wfs.nodisplay",body)).removeClass("nodisplay");}},failure:function(){},scope:this});return true;};},this);},getDefaultTemplate:function(){return new Ext.Template('<p><b>'+this.categoryText+'</b> {category}</p>'+'<p><b>'+this.abstractText+'</b> {abstract}</p>'+'<p><b>'+this.attributionText+'</b> {attribution:this.attributionLink}</p>'+'<p><b>'+this.metadataText+'</b> {metadataURLs:this.metadataLinks}</p>'+'<p><b>'+this.keywordText+'</b> {keywords:this.keywordList}</p>'+'<span class="{formats:this.showDownload}">'+'<p><b>'+this.downloadText+'</b> '+'<a class="download pdf" target="_blank" href="{name:this.pdfUrl}">PDF</a>, '+'<a class="download kml" target="_blank" href="{name:this.kmlUrl}">KML</a>, '+'<a class="download geotiff" target="_blank" href="{name:this.geoTiffUrl}">GeoTIFF</a>'+'<span class="wfs nodisplay">, '+'<a class="download shp" target="_blank" href="{name:this.shpUrl}">SHP (ZIP)</a>'+'</span>'+'</p>'+'</span>');},templateLibrary:{wmsParams:function(name,values,aspect){if(values.llbbox==null){return;}
aspect=aspect||(8.5/11);var dx,dy,dataAspect,widthAdjust,heightAdjust;dx=values.llbbox[2]-values.llbbox[0];dy=values.llbbox[3]-values.llbbox[1];dataAspect=dx/dy;widthAdjust=1;heightAdjust=1;if(dataAspect>aspect){heightAdjust=dataAspect/aspect;}else{widthAdjust=aspect/dataAspect;}
return{service:"wms",request:"GetMap",bbox:this.adjustBounds(widthAdjust,heightAdjust,values.llbbox).toString(),layers:name,srs:"EPSG:4326",width:425,height:550};},adjustBounds:function(widthAdjust,heightAdjust,bbox){var dx,dy,midx,midy;dx=bbox[2]-bbox[0];dy=bbox[3]-bbox[1];midx=(bbox[2]+bbox[0])/2;midy=(bbox[3]+bbox[1])/2;return[midx-(widthAdjust*dx)/2,midy-(heightAdjust*dy)/2,midx+(widthAdjust*dx)/2,midy+(heightAdjust*dy)/2];},wfsParams:function(name,values){return{service:"wfs",request:"GetFeature",typeName:name};},showDownload:function(formats,values){return formats&&formats.indexOf("application/vnd.google-earth.kmz+xml")!==-1&&formats.indexOf("application/pdf")!==-1&&formats.indexOf("image/geotiff")!==-1?"":"nodisplay";},shpUrl:function(name,values){var shpParams=Ext.apply(this.wfsParams(name,values),{outputFormat:'SHAPE-ZIP'});return this.ows()+"?"+Ext.urlEncode(shpParams);},pdfUrl:function(name,values){var pdfParams=Ext.apply(this.wmsParams(name,values),{format:'application/pdf'});return this.ows()+"?"+Ext.urlEncode(pdfParams);},kmlUrl:function(name,values){var kmlParams=Ext.apply(this.wmsParams(name,values),{format:'application/vnd.google-earth.kmz+xml',height:2048,width:2048},1);return this.ows()+"?"+Ext.urlEncode(kmlParams);},geoTiffUrl:function(name,values){var geoTiffParams=Ext.apply(this.wmsParams(name,values),{format:"image/geotiff"});return this.ows()+"?"+Ext.urlEncode(geoTiffParams);},metadataLinks:function(metadataURLs,values){if(metadataURLs==null||metadataURLs.length===0)
{return"<em>"+this.metadataEmptyText+"</em>";}else{var i,links,len;links=[];for(i=0,len=metadataURLs.length;i<len;i++){links.push("<a target=\"_blank\" href=\""+metadataURLs[i].href+"\"> "+
metadataURLs[i].type+"</a>");}
return links.join(", ");}},keywordList:function(keywords,values){if(keywords==null||keywords.length===0)
{return"<em>"+this.keywordEmptyText+"</em>";}else{return keywords.join(", ");}},attributionLink:function(attribution,values){if(attribution==null||attribution.href==null){return"<em>"+this.attributionEmptyText+"</em>";}else{return"<a href=\""+attribution.href+"\"> "+attribution.title+"</a>";}}}});Ext.namespace("GeoNode");GeoNode.MapSearchTable=Ext.extend(Ext.util.Observable,{autoExpandColumn:'title',titleHeaderText:'UT: Title',contactHeaderText:"UT: Contact",lastModifiedHeaderText:"UT: Last Modified",mapAbstractLabelText:"UT: Abstract",mapLinkLabelText:"UT:View this Map",previousText:'UT: Prev',nextText:'UT: Next',ofText:'UT: of',noResultsText:'UT: Your search did not match any items.',searchLabelText:'UT: Search Maps',searchButtonText:'UT: Search',showingText:'UT: Showing',loadingText:'UT: Loading',permalinkText:'UT: permalink',constructor:function(config){this.addEvents('load');Ext.apply(this,config);this.initFromQuery();this.loadData();},loadData:function(){this.searchStore=new Ext.data.JsonStore({url:this.searchURL,root:'rows',idProperty:'name',remoteSort:true,totalProperty:'total',fields:[{name:'id',mapping:'id'},{name:'title',type:'string'},{name:'abstract',type:'string'},{name:'detail',type:'string'},{name:'owner',type:'string'},{name:'owner_detail',type:'string'},{name:'last_modified',type:'string'}]});this.searchStore.on('load',function(){this.updateControls();this.fireEvent('load',this);},this);this.doLayout();this.doSearch();},initFromQuery:function(){if(!this.searchParams){this.searchParams={};}
if(!this.searchParams.start){this.searchParams.start=0;}
if(!this.searchParams.limit){this.searchParams.limit=25;}
if(this.constraints){for(var i=0;i<this.constraints.length;i++){this.constraints[i].initFromQuery(this,this.searchParams);}}},doSearch:function(){this.searchParams.start=0;if(this.constraints){for(var i=0;i<this.constraints.length;i++){this.constraints[i].applyConstraint(this.searchParams);}}
this._search(this.searchParams);},_search:function(params){this.disableControls();this.searchStore.load({params:params});this.updatePermalink(params);},loadNextBatch:function(){this.searchParams.start+=this.searchParams.limit;this._search(this.searchParams);},loadPrevBatch:function(){this.searchParams.start-=this.searchParams.limit;if(this.searchParams.start<0){this.searchParams.start=0;}
this._search(this.searchParams);},disableControls:function(){this.nextButton.setDisabled(true);this.prevButton.setDisabled(true);this.pagerLabel.setText(this.loadingText);},updateControls:function(){var total=this.searchStore.getTotalCount();if(this.searchParams.start>0){this.prevButton.setDisabled(false);}
else{this.prevButton.setDisabled(true);}
if(this.searchParams.start+this.searchParams.limit<total){this.nextButton.setDisabled(false);}
else{this.nextButton.setDisabled(true);}
var minItem=this.searchParams.start+1;var maxItem=minItem+this.searchParams.limit-1;if(maxItem>total){maxItem=total;}
this.pagerLabel.setText(this.showingText+' '+minItem+'-'+maxItem+' '+this.ofText+' '+
total);},updatePermalink:function(){if(this.permalink){this.permalink.href=Ext.urlAppend(this.permalinkURL,Ext.urlEncode(this.searchParams));}},updateQuery:function(){this.searchParams.q=this.queryInput.getValue();this.doSearch();},hookupSearchButtons:function(el){var root=Ext.get(el);var buttons=root.query('.search-button');for(var i=0;i<buttons.length;i++){var text=buttons[i].innerHTML||this.searchButtonText;Ext.get(buttons[i]).update('');var searchButton=new Ext.Button({text:text,renderTo:buttons[i]});searchButton.on('click',this.doSearch,this);}},doLayout:function(){var widgetHTML='<div class="search-results">'+'<div class="search-input"></div>'+'<div class="search-table"></div>'+'<div class="search-controls"></div>'+'</div>';var el=Ext.get(this.renderTo);el.update(widgetHTML);var input_el=el.query('.search-input')[0];var table_el=el.query('.search-table')[0];var controls_el=el.query('.search-controls')[0];var tpl=new Ext.Template('<p><b>'+this.mapAbstractLabelText+':</b> {abstract}</p>'+'<p><a href="/maps/{id}">'+this.mapLinkLabelText+'</a></p>');var expander=new Ext.grid.RowExpander({tpl:tpl});expander.on("expand",function(expander,record,body,idx){Ext.select("a",Ext.get(body)).on("click",function(evt){evt.stopPropagation();});});tableCfg={store:this.searchStore,plugins:[expander],autoExpandColumn:'title',viewConfig:{autoFill:true,forceFit:true,emptyText:this.noResultsText,listeners:{refresh:function(view){Ext.select("a",Ext.get(view.mainBody)).on("click",function(evt){evt.stopPropagation();});},rowsinserted:function(view,start,end){for(var i=start;i<end;i++){Ext.select("a",Ext.get(view.getRow(i))).on("click",function(evt){evt.stopPropagation();});}},rowupdated:function(view,idx,record){Ext.select("a",Ext.get(view.getRow(idx))).on("click",function(evt){evt.stopPropagation();});}}},autoHeight:true,renderTo:table_el};tableCfg.listeners={"rowdblclick":function(grid,rowIndex,evt){var rec=grid.store.getAt(rowIndex);if(rec!=null){location.href=rec.get('detail');}},"rowclick":function(grid,rowIndex,evt){expander.toggleRow(rowIndex);},"beforerender":function(grid){grid.on('render',function(){grid.getView().mainBody.un('mousedown',expander.onMouseDown,expander);})}};var columns=[expander,{header:this.titleHeaderText,dataIndex:'title',id:'title',renderer:function(value,metaData,record,rowIndex,colIndex,store){var detail=record.get('detail');if(detail){return'<a href="'+detail+'">'+value+'</a>';}
else{return value;}}},{header:this.contactHeaderText,dataIndex:'owner',id:'owner',renderer:function(value,metaData,record,rowIndex,colIndex,store){var detail=record.get('owner_detail');if(detail){return'<a href="'+detail+'">'+value+'</a>';}
else{return value;}}},{header:this.lastModifiedHeaderText,dataIndex:'last_modified',id:'last_modified',renderer:function(value,metaData,record,rowIndex,colIndex,store){dt=Date.parseDate(value,'c');return dt.format("F j, Y");}}];var colModel=new Ext.grid.ColumnModel({defaults:{menuDisabled:true,sortable:true},columns:columns});tableCfg.colModel=colModel;this.table=new Ext.grid.GridPanel(tableCfg);this.queryInput=new Ext.form.TextField({fieldLabel:this.searchLabelText,name:'search',allowBlank:true,width:350});this.queryInput.on('specialkey',function(field,e){if(e.getKey()==e.ENTER){this.updateQuery();}},this);var searchButton=new Ext.Button({text:this.searchButtonText});searchButton.on('click',this.updateQuery,this)
var searchForm=new Ext.Panel({frame:false,border:false,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),items:[this.queryInput,searchButton]});searchForm.render(input_el);this.prevButton=new Ext.Button({text:this.previousText});this.prevButton.on('click',this.loadPrevBatch,this);this.nextButton=new Ext.Button({text:this.nextText});this.nextButton.on('click',this.loadNextBatch,this);this.pagerLabel=new Ext.form.Label({text:""});var controls=new Ext.Panel({frame:false,border:false,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:10}}),items:[this.prevButton,this.nextButton,this.pagerLabel]});controls.render(controls_el);this.permalink=Ext.query('a.permalink')[0];this.disableControls();if(this.searchParams.q){this.queryInput.setValue(this.searchParams.q);}
this.updatePermalink();}});Ext.namespace("GeoNode");GeoNode.BatchDownloadWidget=Ext.extend(Ext.util.Observable,{downloadingText:'UT: Downloading...',cancelText:'UT: Cancel',windowMessageText:'UT: Please wait',constructor:function(config){Ext.apply(this,config);this.beginDownload();},beginDownload:function(){var this_widget=this;Ext.Ajax.request({url:this.begin_download_url,method:'POST',params:{layer:this.layers,format:this.format},success:function(result){var result=Ext.util.JSON.decode(result.responseText);this_widget.monitorDownload(result.id);}});},monitorDownload:function(download_id){var checkStatus;var this_widget=this;var pb=new Ext.ProgressBar({text:this.downloadingText});var cancel_download=function(){Ext.Ajax.request({url:this_widget.stop_download_url+download_id,method:"GET",success:function(result){clearInterval(checkStatus);},failure:function(result){clearInterval(checkStatus);}})};var win=new Ext.Window({width:250,height:100,plain:true,modal:true,closable:false,hideBorders:true,items:[pb],buttons:[{text:this.cancelText,handler:function(){cancel_download();win.hide();}}]});var update_progress=function(){Ext.Ajax.request({url:this_widget.begin_download_url+'?id='+download_id,method:"GET",success:function(result){var process=Ext.util.JSON.decode(result.responseText);if(process["process"]["status"]==="FINISHED"){clearInterval(checkStatus);pb.updateProgress(1,"Done....",true);win.close();location.href=this_widget.download_url+download_id;}
else{pb.updateProgress(process["process"]["progress"]/100,this_widget.downloadingText,true);}},failure:function(result){clearInterval(checkStatus);win.close();}});};checkStatus=setInterval(update_progress,1000);win.show();}});Ext.namespace("GeoNode");GeoNode.BoundingBoxWidget=Ext.extend(Ext.util.Observable,{viewerConfig:null,constructor:function(config){Ext.apply(this,config);this.doLayout();},doLayout:function(){var el=Ext.get(this.renderTo);var viewerConfig={proxy:this.proxy,useCapabilities:false,useBackgroundCapabilities:false,useToolbar:false,useMapOverlay:false,portalConfig:{collapsed:true,border:false,height:300,renderTo:el.query('.bbox-expand')[0]},listeners:{"ready":function(){this._ready=true;},scope:this}}
viewerConfig=Ext.apply(viewerConfig,this.viewerConfig)
this.viewer=new GeoExplorer.Viewer(viewerConfig);this.enabledCB=el.query('.bbox-enabled input')[0];this.disable();Ext.get(this.enabledCB).on('click',function(){if(this.enabledCB.checked==true){this.enable();}
else{this.disable();}},this);},isActive:function(){return this.enabledCB.checked==true;},hasConstraint:function(){return this.isActive()},applyConstraint:function(query){if(this.hasConstraint()){var bounds=this.viewer.mapPanel.map.getExtent();bounds.transform(new OpenLayers.Projection(this.viewerConfig.map.projection),new OpenLayers.Projection("EPSG:4326"));query.bbox=bounds.toBBOX();}
else if(this._ready){delete query.bbox;}},initFromQuery:function(grid,query){if(query.bbox){var bounds=OpenLayers.Bounds.fromString(query.bbox);if(bounds){bounds.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection(this.viewerConfig.map.projection));var setMapExtent=function(){var map=this.viewer.mapPanel.map;map.events.register("moveend",this,function(){map.events.unregister("moveend",this,arguments.callee);map.zoomToExtent(bounds,true);});this.enable();};if(this._ready){setMapExtent.call(this);}else{this.viewer.on("ready",setMapExtent,this)}}}},enable:function(){this.enabledCB.checked=true;this.viewer.portal&&this.viewer.portal.expand();},disable:function(){this.enabledCB.checked=false;this.viewer.portal&&this.viewer.portal.collapse();}});Ext.namespace("GeoNode");GeoNode.SearchTableRowExpander=Ext.extend(Ext.grid.RowExpander,{errorText:'UT: Unable to fetch layer details.',loadingText:'UT: Loading...',constructor:function(config){this.fetchURL=config.fetchURL;GeoNode.SearchTableRowExpander.superclass.constructor.call(this,config);},getRowClass:function(record,rowIndex,p,ds){p.cols=p.cols-1;return this.state[record.id]?'x-grid3-row-expanded':'x-grid3-row-collapsed';},fetchBodyContent:function(body,record,index){if(!this.enableCaching){this._fetchBodyContent(body,record,index);}
var content=this.bodyContent[record.id];if(!content){this._fetchBodyContent(body,record,index);}
else{body.innerHTML=content;}},_fetchBodyContent:function(body,record,index){body.innerHTML=this.loadingText;var template_url=this.fetchURL+'?uuid='+record.get('uuid');var this_expander=this;Ext.Ajax.request({url:template_url,method:"GET",success:function(result){var content=result.responseText;body.innerHTML=content;this_expander.bodyContent[record.id]=content;},failure:function(result){body.innerHTML=this_expander.errorText;}});},beforeExpand:function(record,body,rowIndex){if(this.fireEvent('beforeexpand',this,record,body,rowIndex)!==false){this.fetchBodyContent(body,record,rowIndex);return true;}else{return false;}}});Ext.namespace("GeoNode");GeoNode.DataCartOps=Ext.extend(Ext.util.Observable,{failureText:'UT: Operation Failed',noLayersText:'UT: No layers are currently selected.',constructor:function(config){Ext.apply(this,config);this.doLayout();},doLayout:function(){var el=Ext.get(this.renderTo);var createMapLink=Ext.get(el.query('a.create-map')[0]);this.createMapForm=Ext.get(el.query('#create_map_form')[0]);createMapLink.on('click',function(evt){evt.preventDefault();var layers=this.cart.getSelectedLayerIds();if(layers&&layers.length){this.createNewMap(layers);}
else{Ext.MessageBox.alert(this.failureText,this.noLayersText);}},this);batch_links=el.query('a.batch-download');for(var i=0;i<batch_links.length;i++){var bel=Ext.get(batch_links[i]);bel.on('click',function(e,t,o){e.preventDefault();var layers=this.cart.getSelectedLayerIds();if(layers&&layers.length){var format=Ext.get(t).getAttribute('href').substr(1);this.batchDownload(layers,format);}
else{Ext.MessageBox.alert(this.failureText,this.noLayersText);}},this);}},createNewMap:function(layerIds){var inputs=[];for(var i=0;i<layerIds.length;i++){inputs.push({tag:'input',type:'hidden',name:'layer',value:layerIds[i]});}
Ext.DomHelper.overwrite(this.createMapForm,{'tag':'div',cn:inputs});this.createMapForm.dom.submit();},batchDownload:function(layerIds,format){new GeoNode.BatchDownloadWidget({layers:layerIds,format:format,begin_download_url:this.begin_download_url,stop_download_url:this.stop_download_url,download_url:this.download_url});}});Ext.namespace("GeoNode");GeoNode.DataCart=Ext.extend(Ext.util.Observable,{selectedLayersText:'UT: Selected Layers',emptySelectionText:'UT: No Layers Selected',titleText:'UT: Title',clearSelectedButtonText:'UT: Clear Selected',clearAllButtonText:'UT: Clear All',constructor:function(config){Ext.apply(this,config);this.doLayout();},getSelectedLayerIds:function(){var layerIds=[];this.grid.selModel.each(function(rec){layerIds.push(rec.get('name'));});return layerIds;},doLayout:function(){var widgetHTML='<div class="selection-table"></div>'+'<div class="selection-controls"></div>'+'<div class="selection-ops></div>"';var el=Ext.get(this.renderTo);el.update(widgetHTML);var controls_el=el.query('.selection-controls')[0];var table_el=el.query('.selection-table')[0];var ops_el=el.query('.selection-ops')[0];sm=new Ext.grid.CheckboxSelectionModel({});this.grid=new Ext.grid.GridPanel({store:this.store,viewConfig:{autoFill:true,forceFit:true,emptyText:this.emptySelectionText,deferEmptyText:false},height:150,renderTo:table_el,selModel:sm,hideHeaders:true,colModel:new Ext.grid.ColumnModel({defaults:{sortable:false,menuDisabled:true},columns:[sm,{dataIndex:'title'}]})});this.store.on('add',function(store,records,index){sm.selectRow(index,true);})
var clearSelectedButton=new Ext.Button({text:this.clearSelectedButtonText});clearSelectedButton.on('click',function(){sm.each(function(rec){var index=this.store.indexOfId(rec.id);if(index>=0){this.store.removeAt(index);}},this);this.store.reselect();},this);var clearAllButton=new Ext.Button({text:this.clearAllButtonText});clearAllButton.on('click',function(){this.store.removeAll();this.store.reselect();},this);var controlsForm=new Ext.Panel({frame:false,border:false,layout:new Ext.layout.HBoxLayout({defaultMargins:{top:10,bottom:10,left:0,right:0}}),items:[clearSelectedButton,clearAllButton]});controlsForm.render(controls_el);}});Ext.namespace("GeoNode");GeoNode.DataCartStore=Ext.extend(Ext.data.Store,{constructor:function(config){this.selModel=config.selModel;this.reselecting=false;this.selModel.on('rowselect',function(model,index,record){if(this.reselecting==true){return;}
if(this.indexOfId(record.id)==-1){this.add([record]);}},this);this.selModel.on('rowdeselect',function(model,index,record){if(this.reselecting==true){return;}
var index=this.indexOfId(record.id)
if(index!=-1){this.removeAt(index);}},this);GeoNode.DataCartStore.superclass.constructor.call(this,config);},reselect:function(){this.reselecting=true;this.selModel.clearSelections();var store=this.selModel.grid.store;this.each(function(rec){var index=store.indexOfId(rec.id);if(index!=-1){this.selModel.selectRow(index,true);}
return true;},this);this.reselecting=false;}});